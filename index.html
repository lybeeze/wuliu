<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>快递管家 v45.0 (Siri增强)</title>
    <style>
        :root {
            --bg: #f2f2f7; --card: #ffffff;
            --primary: #007aff; --danger: #ff3b30; --success: #34c759;
            --text-main: #1d1d1f; --text-sub: #86868b; --highlight: #fff59d;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif; background-color: var(--bg); margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; user-select: none; color: var(--text-main); overscroll-behavior-y: none; }

        /* 顶部 */
        .status-bar { position: fixed; top: 0; left: 0; width: 100%; height: 44px; z-index: 100; background: rgba(242, 242, 247, 0.95); backdrop-filter: blur(10px); border-bottom: 0.5px solid rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; padding: 0 16px; box-sizing: border-box; }
        .bar-time { font-family: monospace; font-size: 12px; font-weight: 600; }
        .bar-title { font-size: 17px; font-weight: 700; flex: 1; text-align: center; }
        .bar-search { font-size: 14px; color: var(--primary); font-weight: 600; cursor: pointer; }

        /* 搜索面板 */
        .search-layer { position: fixed; top: 44px; left: 0; width: 100%; height: 50px; background: #fff; z-index: 99; display: flex; align-items: center; padding: 0 10px; box-sizing: border-box; border-bottom: 0.5px solid rgba(0,0,0,0.1); transform: translateY(-100%); transition: transform 0.25s ease; }
        .search-layer.show { transform: translateY(0); }
        .search-input { flex: 1; height: 32px; background: #e3e3e8; border: none; border-radius: 8px; padding: 0 12px; font-size: 14px; outline: none; }
        mark { background-color: var(--highlight); color: #d63384; padding: 0 2px; border-radius: 2px; font-weight: bold; }

        .container { padding: 60px 16px 100px; overflow-x: hidden; }

        /* 输入区 */
        .input-card { background: var(--card); border-radius: 12px; padding: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); margin-bottom: 24px; }
        .row { display: flex; gap: 10px; margin-bottom: 12px; }
        input, select { height: 40px; border: 1px solid #e5e5ea; border-radius: 8px; background: #fff; width: 100%; font-size: 14px; padding: 0 10px; box-sizing: border-box; outline: none; -webkit-appearance: none; }
        .col-5 { flex: 5; } .col-6 { flex: 6; } .col-4 { flex: 4; }
        #addBtn { width: 100%; height: 44px; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; }
        
        /* 必填提示 */
        .req-border { border-left: 3px solid var(--danger); }

        /* 列表 */
        .sec-header { display: flex; justify-content: space-between; align-items: center; padding: 4px; margin-bottom: 8px; font-size: 12px; font-weight: 700; color: var(--text-sub); text-transform: uppercase; }
        .badge { background: #e5e5ea; padding: 2px 6px; border-radius: 6px; font-size: 10px; }

        /* 待签收卡片 */
        .p-card { background: #fff; border-radius: 10px; padding: 14px; margin-bottom: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.03); position: relative; border-left: 4px solid #ff9f0a; }
        .p-card.arrived { border-left-color: var(--success); }
        .p-del-btn { position: absolute; top: 10px; right: 10px; width: 24px; height: 24px; background: #f5f5f7; border-radius: 50%; color: #999; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .p-info { margin-bottom: 8px; padding-right: 25px; }
        .p-main { font-size: 16px; font-weight: 600; margin-bottom: 4px; display: block; }
        .p-sub { font-size: 12px; color: #666; display: flex; flex-wrap: wrap; gap: 5px; }
        .tag { padding: 1px 5px; border-radius: 4px; font-size: 10px; }
        .t-code { background: #fff8e1; color: #f57c00; }
        .t-note { background: #f0f0f0; color: #666; }
        .p-acts { display: flex; gap: 10px; }
        .act-btn { flex: 1; height: 32px; border-radius: 6px; border: none; font-size: 12px; font-weight: 600; cursor: pointer; }
        .b-tog { background: #fff; border: 1px solid #ddd; color: #333; }
        .b-ok { background: var(--success); color: white; }
        .b-dis { background: #eee; color: #bbb; pointer-events: none; }

        /* 签收记录 (v21风格) */
        .swipe-item { position: relative; height: 80px; margin-bottom: 8px; border-radius: 10px; overflow: hidden; background: #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.03); }
        .swipe-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; justify-content: space-between; z-index: 1; }
        .bg-btn { width: 80px; height: 100%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; font-size: 14px; }
        .bg-left { background-color: var(--primary); } 
        .bg-right { background-color: var(--danger); }
        .swipe-fg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 2; padding: 0 16px; display: flex; flex-direction: column; justify-content: center; will-change: transform; transition: transform 0.1s linear; }
        .animating { transition: transform 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28); }
        .s-main { font-size: 15px; font-weight: 600; }
        .s-sub { font-size: 12px; color: #888; margin-top: 4px; display: flex; justify-content: space-between; }

        /* 垃圾箱 */
        .trash-box { margin-top: 30px; text-align: center; }
        .trash-head { font-size: 12px; color: #aaa; cursor: pointer; margin-bottom: 10px; }
        .trash-list { background: #fff; border-radius: 10px; padding: 10px; text-align: left; }
        .trash-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed #eee; font-size: 12px; color: #999; }
        .trash-row:last-child { border: none; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="status-bar">
    <div class="bar-time" id="clock">--:--</div>
    <div class="bar-title">快递管家</div>
    <div class="bar-search" onclick="toggleSearch()">搜索</div>
</div>

<div class="search-layer" id="searchLayer">
    <input class="search-input" id="sInput" placeholder="输入关键字..." oninput="render()">
    <div style="padding:0 12px;color:var(--primary)" onclick="toggleSearch()">取消</div>
</div>

<div class="container">
    <div class="input-card">
        <div class="row">
            <select id="carrier" class="req-border"><option value="">快递(必选)</option><option>京东</option><option>顺丰</option><option>中通</option><option>圆通</option><option>申通</option><option>韵达</option><option>极兔</option><option>邮政</option><option>菜鸟</option><option>丹鸟</option><option>德邦</option><option>其他</option></select>
            <select id="source" class="req-border"><option value="">来源(必选)</option><option>抖音</option><option>淘宝</option><option>京东</option><option>拼多多</option><option>小红书</option><option>闲鱼</option><option>微信</option><option>其他</option></select>
        </div>
        <div class="row">
            <input id="pkgCode" class="col-5" placeholder="取件码">
            <input id="pkgTrack" class="col-5" placeholder="运单号">
        </div>
        <div class="row">
            <input id="pkgName" class="col-6" placeholder="物品名称">
            <input id="pkgNote" class="col-4" placeholder="备注">
        </div>
        <button id="addBtn" onclick="addPkg()">入库</button>
    </div>

    <div class="sec-header"><span>待签收</span><span class="badge" id="c1">0</span></div>
    <div id="listPending"></div>

    <div class="sec-header" style="margin-top:20px"><span>签收记录 (左丢弃/右撤回)</span><span class="badge" id="c2">0</span></div>
    <div id="listSigned"></div>

    <div class="trash-box">
        <div class="trash-head" onclick="document.getElementById('listTrash').classList.toggle('hidden')">回收站 (保留10条) ▼</div>
        <div id="listTrash" class="trash-list hidden"></div>
    </div>
</div>

<script>
    const KEY = 'kuaidi_v45_siri_pro';
    let list = [];

    // 音效与语音
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    let ac;
    function play(t) {
        if(!ac) ac = new AudioContext(); if(ac.state==='suspended') ac.resume();
        const o=ac.createOscillator(), g=ac.createGain(); o.connect(g); g.connect(ac.destination);
        const n=ac.currentTime;
        if(t==='ok'){o.frequency.setValueAtTime(500,n);o.frequency.linearRampToValueAtTime(800,n+0.1);g.gain.linearRampToValueAtTime(0,n+0.2);o.start(n);o.stop(n+0.2);}
        if(t==='del'){o.type='triangle';o.frequency.setValueAtTime(100,n);g.gain.linearRampToValueAtTime(0,n+0.15);o.start(n);o.stop(n+0.15);}
    }
    function speak(text) {
        if ('speechSynthesis' in window) {
            const u = new SpeechSynthesisUtterance(text);
            u.lang = 'zh-CN'; u.rate = 1.1;
            window.speechSynthesis.speak(u);
        }
    }

    // Siri 唤醒逻辑
    window.onload = function() {
        const params = new URLSearchParams(window.location.search);
        const siriText = params.get('q') || params.get('text');
        if(siriText) {
            // 延迟一点执行，确保DOM加载
            setTimeout(() => parseAndAdd(decodeURIComponent(siriText), true), 500);
        }
        setInterval(()=>{
            const d=new Date(); document.getElementById('clock').innerText=`${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`;
        }, 1000);
    };

    try { const s=localStorage.getItem(KEY)||localStorage.getItem('kuaidi_v21_audio'); if(s) list=JSON.parse(s); } catch(e){ list=[]; }
    function save() { localStorage.setItem(KEY, JSON.stringify(list)); render(); }

    // --- 核心：智能清洗与识别 ---
    function cleanText(t) {
        // 1. 去除 Siri 可能会加的空格： 3 - 1 - 205 -> 3-1-205
        t = t.replace(/(\d)\s*-\s*(\d)/g, '$1-$2');
        // 2. 统一标点
        t = t.replace(/，/g, ' ').replace(/。/g, ' ').replace(/\n/g, ' ');
        return t;
    }

    function parseAndAdd(rawText, isSiri = false) {
        if(!rawText) return;
        let t = cleanText(rawText);
        
        let cVal="", sVal="", codeVal="", trackVal="", nameVal="", noteVal="";

        // 1. 快递
        const map={'京东':'京东','顺丰':'顺丰','中通':'中通','圆通':'圆通','申通':'申通','韵达':'韵达','极兔':'极兔','邮政':'邮政','EMS':'邮政','菜鸟':'菜鸟','丹鸟':'丹鸟','德邦':'德邦'};
        for(let k in map) if(t.includes(k)) cVal = map[k];

        // 2. 来源
        const srcs=['抖音','淘宝','京东','拼多多','小红书','咸鱼','微信','唯品会','快手'];
        for(let s of srcs) if(t.toUpperCase().includes(s)) sVal = s;

        // 3. 取件码 (增强版正则)
        // 支持: 3-1-101, A102, 5-2003
        let cm = t.match(/([A-Za-z0-9]+-[0-9]+(-[0-9]+)?)/); 
        if(!cm) cm = t.match(/(?:取件码|码)\s*[:：]?\s*([0-9A-Za-z-]{3,10})/);
        if(cm) codeVal = cm[1] || cm[0];

        // 4. 运单
        let tr = t.match(/(SF[0-9A-Za-z]+|JD[0-9A-Za-z]+|\d{12,})/);
        if(tr && !/^1\d{10}$/.test(tr[0])) trackVal = tr[0];

        // 5. 物品名称 (暴力提取)
        // 移除已知的关键词，剩下的可能就是名字
        let tempT = t;
        const keywords = [cVal, sVal, codeVal, trackVal, '快递', '取件', '码', '单号', '发', '的', '是', '在', '买', '了', '我', '。', '，'];
        keywords.forEach(k => { if(k) tempT = tempT.split(k).join(' '); });
        // 取最长的一段作为名字
        let parts = tempT.split(/\s+/).filter(x => x.length > 1 && x.length < 15);
        if(parts.length > 0) nameVal = parts[0];

        // 填充
        if(cVal) document.getElementById('carrier').value = cVal;
        if(sVal) document.getElementById('source').value = sVal;
        if(codeVal) document.getElementById('pkgCode').value = codeVal;
        if(trackVal) document.getElementById('pkgTrack').value = trackVal;
        if(nameVal) document.getElementById('pkgName').value = nameVal;

        // 自动提交逻辑
        if(isSiri) {
            if(cVal && sVal) {
                addPkg(); // 自动入库
                // 语音反馈
                let speakTxt = `已添加${sVal}的${nameVal||'快递'}`;
                speak(speakTxt);
            } else {
                // 如果必填项缺失，尝试猜测
                if(!sVal) document.getElementById('source').value = '其他';
                if(!cVal && t.includes('驿站')) document.getElementById('carrier').value = '菜鸟';
                
                // 二次检查
                if(document.getElementById('carrier').value && document.getElementById('source').value) {
                    addPkg();
                    speak('已添加');
                }
            }
        }
    }

    // --- 渲染与交互 ---
    function hl(str, k) { if(!str)return''; if(!k)return str; return str.replace(new RegExp(`(${k})`,'gi'), '<mark>$1</mark>'); }
    function ft(ts) { if(!ts)return''; const d=new Date(ts); const p=n=>n.toString().padStart(2,'0'); return `${d.getFullYear()}/${p(d.getMonth()+1)}/${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}:${p(d.getSeconds())}`; }

    function render() {
        const kw = document.getElementById('sInput').value.toLowerCase().trim();
        const pL=document.getElementById('listPending'), sL=document.getElementById('listSigned'), tL=document.getElementById('listTrash');
        pL.innerHTML=''; sL.innerHTML=''; tL.innerHTML='';
        let c1=0, c2=0, c3=0;

        list.filter(i=>i.st==='p' && (i.n+i.c+i.code+ft(i.t1)).toLowerCase().includes(kw)).sort((a,b)=>b.t1-a.t1).forEach(i=>{
            c1++;
            const arr = i.sub==='arr';
            const div = document.createElement('div');
            div.className = arr ? 'p-card arrived' : 'p-card transit';
            const tags = [];
            if(i.code) tags.push(`<span class="tag t-code">${hl(i.code, kw)}</span>`);
            if(i.track) tags.push(`<span class="tag t-track">单号</span>`);
            
            div.innerHTML = `
                <div class="p-del-txt" onclick="toTrash('${i.id}')">删除</div>
                <div class="p-main">${hl(i.n||'未知物品', kw)}</div>
                <div class="p-sub"><span>${hl(i.c, kw)}·${hl(i.s, kw)}</span> ${tags.join('')}</div>
                <div class="p-sub" style="margin-top:4px;color:#ccc;font-size:10px">${arr?'到站':'入库'}: ${hl(ft(arr?i.t_arr:i.t1), kw)}</div>
                <div class="p-foot"><button class="btn-act b-tog" onclick="tog('${i.id}')">${arr?'撤回状态':'确认到站'}</button><button class="btn-act ${arr?'b-ok':'b-dis'}" onclick="sign('${i.id}')">签收</button></div>`;
            pL.appendChild(div);
        });

        list.filter(i=>i.st==='s' && (i.n+i.c+ft(i.t2)).toLowerCase().includes(kw)).sort((a,b)=>b.t2-a.t2).forEach(i=>{
            c2++;
            const el = document.createElement('div');
            el.className = 'swipe-item';
            const cStr = i.code ? ` <span class="tag t-code">${hl(i.code,kw)}</span>` : '';
            el.innerHTML = `
                <div class="swipe-bg"><div class="bg-btn bg-left" onclick="revert('${i.id}')">撤回</div><div class="bg-btn bg-right" onclick="toTrash('${i.id}')">丢弃</div></div>
                <div class="swipe-fg" ontouchstart="ts(event,this)" ontouchmove="tm(event,this)" ontouchend="te(event,this,'${i.id}')">
                    <div class="s-main">${hl(i.n||i.c, kw)}</div>
                    <div class="s-sub"><span>${hl(i.c, kw)} ${cStr}</span><span style="font-family:monospace;color:#bbb">${hl(ft(i.t2), kw)}</span></div>
                </div>`;
            sL.appendChild(el);
        });

        const tItems = list.filter(i=>i.st==='d').sort((a,b)=>b.t1-a.t1); c3=tItems.length;
        tItems.slice(0, 10).forEach(i=>{ tL.innerHTML += `<div class="trash-row"><span>${i.n||i.c}</span><span style="color:#007aff;cursor:pointer" onclick="restore('${i.id}')">恢复</span></div>`; });
        document.getElementById('c1').innerText=c1; document.getElementById('c2').innerText=c2; document.getElementById('c3').innerText=c3;
    }

    function addPkg(){
        const c=document.getElementById('carrier').value; const s=document.getElementById('source').value;
        if(!c || !s){ alert('请选择 快递公司 和 来源平台'); return; }
        list.push({id:Date.now()+'', c:c, s:s, code:v('pkgCode'), n:v('pkgName'), track:v('pkgTrack'), note:v('pkgNote'), st:'p', sub:'tr', t1:Date.now()});
        save();
        ['pkgName','pkgCode','pkgTrack','pkgNote'].forEach(id=>document.getElementById(id).value='');
        play('ok');
    }
    function v(id){return document.getElementById(id).value.trim();}
    function tog(id){let i=list.find(x=>x.id===id); if(i){i.sub=i.sub==='tr'?'arr':'tr'; if(i.sub==='arr') i.t_arr=Date.now(); save(); play('ok');}}
    function sign(id){let i=list.find(x=>x.id===id); if(i&&i.sub==='arr'){i.st='s'; i.t2=Date.now(); save(); play('ok');}}
    function toTrash(id){ 
        let i=list.find(x=>x.id===id); if(i){ i.st='d'; let trash=list.filter(x=>x.st==='d').sort((a,b)=>b.t1-a.t1); if(trash.length>10){ let ks=trash.slice(0,10).map(x=>x.id); list=list.filter(x=>x.st!=='d'||ks.includes(x.id)); } save(); play('del'); }
    }
    function revert(id){let i=list.find(x=>x.id===id); if(i){i.st='p'; i.sub='arr'; save(); play('ok');}}
    function restore(id){let i=list.find(x=>x.id===id); if(i){i.st='p'; save(); play('ok');}}
    function emptyTrash(){if(confirm('清空?')){list=list.filter(x=>x.st!=='d'); save();}}
    function toggleSearch(){ document.getElementById('searchLayer').classList.toggle('show'); document.getElementById('sInput').focus(); }

    let sx=0;
    function ts(e,el){ sx=e.touches[0].clientX; el.classList.remove('animating'); document.querySelectorAll('.swipe-fg').forEach(d=>{if(d!==el){d.classList.add('animating');d.style.transform='translateX(0)';}});}
    function tm(e,el){ let dx=e.touches[0].clientX-sx; if(Math.abs(dx)<100) el.style.transform=`translateX(${dx}px)`; }
    function te(e,el,id){ let dx=e.changedTouches[0].clientX-sx; el.classList.add('animating'); if(dx<-60) { el.style.transform='translateX(-100%)'; setTimeout(()=>toTrash(id),200); } else if(dx>60) { el.style.transform='translateX(100%)'; setTimeout(()=>revert(id),200); } else el.style.transform='translateX(0)'; }

    render();
</script>
</body>
</html>
